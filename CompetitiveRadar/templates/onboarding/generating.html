{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 50px auto;">
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 2.5rem; margin-bottom: 15px;">âœ¨ Generating Your Digest</h1>
        <p style="font-size: 1.2rem; color: #666;">Our AI agents are creating your personalized competitive intelligence report...</p>
        
        <div style="margin: 30px auto; max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; position: relative;">
                <div style="position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: black; z-index: 0;"></div>
                <div class="step-indicator active" style="position: relative; z-index: 1;">1</div>
                <div class="step-indicator active" style="position: relative; z-index: 1;">2</div>
                <div class="step-indicator active" style="position: relative; z-index: 1;">3</div>
                <div class="step-indicator active" style="position: relative; z-index: 1;">4</div>
                <div class="step-indicator active" style="position: relative; z-index: 1;">5</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; color: #666;">
                <span>Type</span>
                <span>Description</span>
                <span>Discovery</span>
                <span>Select</span>
                <span>Complete</span>
            </div>
        </div>
    </div>

    <div id="generatingState">
        <div style="text-align: center; padding: 40px 20px;">
            <div class="loading-spinner" style="margin: 0 auto 30px;"></div>
            
            <div id="agentProgress" style="max-width: 600px; margin: 0 auto;">
                <div class="agent-step" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; opacity: 0.5;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="step-number">1</div>
                        <div>
                            <strong>Research Agent</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: #666;">Analyzing competitor data from 50+ sources...</p>
                        </div>
                    </div>
                </div>

                <div class="agent-step" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; opacity: 0.5;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="step-number">2</div>
                        <div>
                            <strong>Categorization Agent</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: #666;">Classifying updates by Product, Pricing, Marketing...</p>
                        </div>
                    </div>
                </div>

                <div class="agent-step" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; opacity: 0.5;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="step-number">3</div>
                        <div>
                            <strong>Prioritization Agent</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: #666;">Scoring insights based on competitive impact...</p>
                        </div>
                    </div>
                </div>

                <div class="agent-step" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; opacity: 0.5;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="step-number">4</div>
                        <div>
                            <strong>Summarization Agent</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: #666;">Creating your actionable digest...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="successState" style="display: none; text-align: center; padding: 40px 20px;">
        <div style="font-size: 4rem; margin-bottom: 20px;">ðŸŽ‰</div>
        <h2 style="margin-bottom: 15px;">Your Digest is Ready!</h2>
        <p style="color: #666; margin-bottom: 30px;">We've analyzed your competitors and created a personalized digest with actionable insights.</p>
        <button onclick="viewDigest()" class="btn-primary" style="padding: 15px 50px; font-size: 1.1rem;">
            View My Digest â†’
        </button>
    </div>
</div>

<style>
.step-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 2px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #999;
}

.step-indicator.active {
    background: black;
    color: white;
    border-color: black;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid black;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 2px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.agent-step.active {
    opacity: 1;
    animation: pulse 0.5s;
}

.agent-step.active .step-number {
    background: black;
    color: white;
    border-color: black;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}
</style>

<script>
async function generateDigest() {
    const steps = document.querySelectorAll('.agent-step');
    
    // Animate through steps
    for (let i = 0; i < steps.length; i++) {
        await new Promise(resolve => setTimeout(resolve, 800));
        steps[i].classList.add('active');
    }
    
    try {
        const response = await fetch('/api/generate-personalized-digest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();
        
        if (data.success) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            showSuccess();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error generating digest. Redirecting to homepage...');
        window.location.href = '/';
    }
}

function showSuccess() {
    document.getElementById('generatingState').style.display = 'none';
    document.getElementById('successState').style.display = 'block';
}

function viewDigest() {
    window.location.href = '/onboarding/personalized-digest';
}

// Start generation when page loads
window.onload = () => {
    generateDigest();
};
</script>
{% endblock %}
