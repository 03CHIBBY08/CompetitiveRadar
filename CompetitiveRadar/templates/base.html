<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CompetitiveRadar - AI-Powered Competitor Intelligence{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/">CompetitiveRadar</a>
            </div>
            <ul class="nav-menu">
                <li><a href="/demo" class="{% if request.endpoint == 'demo' %}active{% endif %}">Demo</a></li>
                <li><a href="/features" class="{% if request.endpoint == 'features' %}active{% endif %}">Features</a></li>
                <li><a href="/pricing" class="{% if request.endpoint == 'pricing' %}active{% endif %}">Pricing</a></li>
                <li><a href="/credible" class="{% if request.endpoint == 'credible' %}active{% endif %}">Credible</a></li>
                <li><a href="/get-started" class="btn-primary">Get Started</a></li>
            </ul>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2025 CompetitiveRadar. Transform hours of competitor tracking into 30-second insights.</p>
            <p class="demo-badge">ðŸ¤– AI Agents Connected - Powered by Google Gemini (FREE)</p>
        </div>
    </footer>

    <!-- AI Chatbot Widget -->
    <div class="chatbot-widget">
        <button class="chatbot-toggle" id="chatbotToggle" onclick="toggleChatbot()">ðŸ’¬</button>
        
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>ðŸ¤– CompetitiveRadar Assistant</h3>
                <button class="chatbot-close" onclick="toggleChatbot()">Ã—</button>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="chat-message">
                    <div class="message-bot">
                        ðŸ‘‹ Hi! I'm your CompetitiveRadar assistant. I can help you with:
                        <div class="quick-suggestions">
                            <button class="quick-suggestion" onclick="sendQuickMessage('How does CompetitiveRadar work?')">How it works</button>
                            <button class="quick-suggestion" onclick="sendQuickMessage('What are the pricing plans?')">Pricing</button>
                            <button class="quick-suggestion" onclick="sendQuickMessage('How do I get started?')">Get started</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chatbot-input-area">
                <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Ask me anything..." onkeypress="handleChatKeypress(event)">
                <button class="chatbot-send" onclick="sendChatMessage()">âž¤</button>
            </div>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="globalLoadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
            <div class="loading-spinner" style="margin: 0 auto 20px; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid black; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin: 0; font-weight: bold;">Loading...</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        button.loading, a.loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }
        
        button.loading::after, a.loading::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
    </style>

    <script>
        // Global click loading animation
        document.addEventListener('click', function(e) {
            const target = e.target.closest('button, a');
            
            if (target && !target.classList.contains('chatbot-toggle') && !target.classList.contains('chatbot-close') && !target.classList.contains('quick-suggestion')) {
                // Don't add loading to certain elements
                if (target.classList.contains('chatbot-send') || target.getAttribute('onclick')?.includes('Chatbot')) {
                    return;
                }
                
                // Add loading class
                target.classList.add('loading');
                
                // For form submissions and navigation links, show overlay
                const href = target.getAttribute('href');
                const type = target.getAttribute('type');
                
                if ((href && href !== '#' && !href.startsWith('javascript:')) || type === 'submit') {
                    setTimeout(() => {
                        const overlay = document.getElementById('globalLoadingOverlay');
                        if (overlay) {
                            overlay.style.display = 'flex';
                        }
                    }, 200);
                }
                
                // Remove loading class after delay for async operations
                setTimeout(() => {
                    target.classList.remove('loading');
                }, 3000);
            }
        });
        
        function toggleChatbot() {
            const chatWindow = document.getElementById('chatbotWindow');
            const toggle = document.getElementById('chatbotToggle');
            
            if (chatWindow.classList.contains('open')) {
                chatWindow.classList.remove('open');
                toggle.textContent = 'ðŸ’¬';
            } else {
                chatWindow.classList.add('open');
                toggle.textContent = 'âœ•';
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendQuickMessage(message) {
            const input = document.getElementById('chatbotInput');
            input.value = message;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesContainer = document.getElementById('chatbotMessages');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message';
            userMsg.innerHTML = `<div class="message-user">${escapeHtml(message)}</div>`;
            messagesContainer.appendChild(userMsg);
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message';
            typingIndicator.id = 'typingIndicator';
            typingIndicator.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingIndicator);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                typingIndicator.remove();
                
                // Check if response is valid
                if (response.ok && data && data.response) {
                    // Add bot response
                    const botMsg = document.createElement('div');
                    botMsg.className = 'chat-message';
                    botMsg.innerHTML = `<div class="message-bot">${escapeHtml(data.response)}</div>`;
                    messagesContainer.appendChild(botMsg);
                } else {
                    // Handle error response
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'chat-message';
                    errorMsg.innerHTML = `<div class="message-bot">Sorry, I'm having trouble right now. Please try asking about pricing, features, or the demo!</div>`;
                    messagesContainer.appendChild(errorMsg);
                }
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
            } catch (error) {
                typingIndicator.remove();
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message';
                errorMsg.innerHTML = `<div class="message-bot">Sorry, I encountered an error. Please try again or use the quick suggestions below!</div>`;
                messagesContainer.appendChild(errorMsg);
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
